//******************************************
// порты подключения моторов
int MotorLeftActiv = 4;//Вперед или назад левый двигатель
int MotorLeftSpeed = 5;//Скорость левого двигателя
int MotorRightActic = 7;//Вперед или назад правый двигатель
int MotorRightSpeed = 6;//Скорость правого двигателя

int Skorost = 200;//Скорость

int dal_p = 0;//
//int dalnostSprava = 0;//Дальность справа

// Дальномер правый датчик
int echoPin_R = 12; //Порт echo
int trigPin_R = 13;//Порт trig
// Дальномер средний датчик
int echoPin_C = 10; //Порт echo
int trigPin_C = 11;//Порт trig
// Дальномер Левый датчик
int echoPin_L = 9; //Порт echo
int trigPin_L = 8;//Порт trig

void Vpered(int Speed)//Двигаться вперед
{
  digitalWrite(MotorLeftActiv,HIGH);
  analogWrite(MotorLeftSpeed,Speed);
  digitalWrite(MotorRightActic,HIGH);
  analogWrite(MotorRightSpeed,Speed);
}

void Nazad(int Speed)//Двигаться назад
{
  digitalWrite(MotorLeftActiv,LOW);
  analogWrite(MotorLeftSpeed,Speed);
  digitalWrite(MotorRightActic,LOW);
  analogWrite(MotorRightSpeed,Speed);
}

void Stop()//Остановиться
{
  digitalWrite(MotorLeftActiv,LOW);
  analogWrite(MotorLeftSpeed,0);
  digitalWrite(MotorRightActic,LOW);
  analogWrite(MotorRightSpeed,0);
}

void VlevoVperet(int Speed)//Двигаться вперед влево
{
  digitalWrite(MotorLeftActiv,HIGH);
  analogWrite(MotorLeftSpeed,0);
  digitalWrite(MotorRightActic,HIGH);
  analogWrite(MotorRightSpeed,Speed);
}

void VpravoVperet(int Speed)//Двигаться вперед вправо
{
  digitalWrite(MotorLeftActiv,HIGH);
  analogWrite(MotorLeftSpeed,Speed);
  digitalWrite(MotorRightActic,HIGH);
  analogWrite(MotorRightSpeed,0);
}

void VlevoNazad(int Speed)//Двигаться назад влево
{
  digitalWrite(MotorLeftActiv,LOW);
  analogWrite(MotorLeftSpeed,Speed);
  digitalWrite(MotorRightActic,HIGH);
  analogWrite(MotorRightSpeed,0);
}

void VpravoNazad(int Speed)//Двигаться назад вправо
{
  digitalWrite(MotorLeftActiv,HIGH);
  analogWrite(MotorLeftSpeed,0);
  digitalWrite(MotorRightActic,LOW);
  analogWrite(MotorRightSpeed,Speed);
}

void NamesteVlevo(int Speed)//Вращаться на месте влево
{
  digitalWrite(MotorLeftActiv,LOW);
  analogWrite(MotorLeftSpeed,Speed);
  digitalWrite(MotorRightActic,HIGH);
  analogWrite(MotorRightSpeed,Speed);
}

void NamesteVpravo(int Speed)//Вращаться на месте вправо
{
  digitalWrite(MotorLeftActiv,HIGH);
  analogWrite(MotorLeftSpeed,Speed);
  digitalWrite(MotorRightActic,LOW);
  analogWrite(MotorRightSpeed,Speed);
}
//*********************************
// Дальность с права
int distance_R(){
  int dalnost = 0;//Дальность спереди
  float ds=0;
  for(int i=0; i<3; i++){
    //Замер дистанции перед собой
    digitalWrite(trigPin_R, LOW); 
    delayMicroseconds(2); 
    digitalWrite(trigPin_R, HIGH); 
    delayMicroseconds(10); 
    digitalWrite(trigPin_R, LOW); 
    dalnost = pulseIn(echoPin_R, HIGH); 
    dalnost = dalnost / 58;
    ds=ds+dalnost;
    delay(50);
  }
  ds=ds/3;
  dalnost=ds;
  Serial.print("R = ");
  Serial.println(dalnost);
  return dalnost;
}
//*********************************
// Дальность с переди
int distance_C(){
  int dalnost = 0;//Дальность спереди
  float ds=0;
  for(int i=0; i<3; i++){
    //Замер дистанции перед собой
    digitalWrite(trigPin_C, LOW); 
    delayMicroseconds(2); 
    digitalWrite(trigPin_C, HIGH); 
    delayMicroseconds(10); 
    digitalWrite(trigPin_C, LOW); 
    dalnost = pulseIn(echoPin_C, HIGH); 
    dalnost = dalnost / 58;
    ds=ds+dalnost;
    delay(50);
  }
  ds=ds/3;
  dalnost=ds;
  Serial.print("C = ");
  Serial.println(dalnost);
  return dalnost;
}
//*********************************
// Дальность с лева
int distance_L(){
  int dalnost = 0;//Дальность спереди
  float ds=0;
  for(int i=0; i<3; i++){
    //Замер дистанции перед собой
    digitalWrite(trigPin_L, LOW); 
    delayMicroseconds(2); 
    digitalWrite(trigPin_L, HIGH); 
    delayMicroseconds(10); 
    digitalWrite(trigPin_L, LOW); 
    dalnost = pulseIn(echoPin_L, HIGH); 
    dalnost = dalnost / 58;
    ds=ds+dalnost;
    delay(50);
  }
  ds=ds/3;
  dalnost=ds;
  Serial.print("L = ");
  Serial.println(dalnost);
  return dalnost;
}

void setup()
{  
  Serial.begin(9600);
  Serial.println("START");
  //Настойки моторов
  pinMode(MotorLeftActiv, OUTPUT);
  pinMode(MotorLeftSpeed, OUTPUT);
  pinMode(MotorRightSpeed, OUTPUT);
  pinMode(MotorRightActic, OUTPUT);
  
  
  //Настойки Дальномера
  pinMode(trigPin_R, OUTPUT); 
  pinMode(echoPin_R, INPUT);
  pinMode(trigPin_C, OUTPUT); 
  pinMode(echoPin_C, INPUT);
  pinMode(trigPin_L, OUTPUT); 
  pinMode(echoPin_L, INPUT);

/*
     Vpered(Skorost); //Двигаться вперед
     delay(2000);
     Stop();
*/ 
}

void loop() { 

  // Замеряем расстояния
  int ds_L, ds_R, ds_C;
//  ds_L = distance_L();
//  while(ds_L<0){ds_L = distance_L();}
  ds_C = distance_C();
  while(ds_C<0){ds_C = distance_C();}
//  ds_R = distance_R();
//  while(ds_R<0){ds_R = distance_R();}

  // Проверяем и едим в нужном направлении
  // если в переди растояние меньше 10см  
  if (ds_C <10){
    Stop();
    ds_L = distance_L();
    while(ds_L<0){ds_L = distance_L();}
    ds_C = distance_C();
    while(ds_C<0){ds_C = distance_C();}
    ds_R = distance_R();
    while(ds_R<0){ds_R = distance_R();}
    // проверяем по сторонам
    // если с лева и с права больше 20см
    if(ds_L>15||ds_R>15){
      if (ds_R>ds_L){
        // поворачиваем в право
        Serial.println("pravo");
        NamesteVpravo(Skorost);
        delay(50);
        Stop();
        ds_C = distance_C();
        while(ds_C<0){ds_C = distance_C();}  
        int pr_ds_C = ds_C;    
        while(ds_C < 30){
          NamesteVpravo(Skorost);
          delay(50);
          Stop();
          delay(3);
          pr_ds_C = ds_C;
          ds_C = distance_C();
          while(ds_C<0){ds_C = distance_C();}     
        }
      }else{
        // поворачиваем в лево
        Serial.println("levo");
        NamesteVlevo(Skorost);
        delay(50);
        Stop();
        ds_C = distance_C();
        while(ds_C<0){ds_C = distance_C();}  
        int pr_ds_C = ds_C;   
        while(ds_C < 30){
          NamesteVlevo(Skorost);
          delay(50);
          Stop();
          delay(3);
          pr_ds_C = ds_C;
          ds_C = distance_C();
          while(ds_C<0){ds_C = distance_C();}     
        }
      }
    }else{
        NamesteVpravo(Skorost);
        delay(50);
        Stop();
        ds_C = distance_C();
        while(ds_C<0){ds_C = distance_C();} 
        int pr_ds_C = ds_C;
        while(ds_C < 30){
          NamesteVpravo(Skorost);
          delay(50);
          Stop();
          delay(3);
          pr_ds_C = ds_C;
          ds_C = distance_C();
          while(ds_C<0){ds_C = distance_C();}     
        }
    }
  }else{
     Vpered(Skorost); //Двигаться вперед
     delay(70);
     Stop();
    
  }
  
  
  /*
  if(distance() > 10)//Проверка дистанции если она больше или равна 30 см ехать дальше
  {
     Vpered(Skorost); //Двигаться вперед
     delay(200);
     Stop();
  }
  else//Иначе
  {
      NamesteVpravo(Skorost);
      delay(200);
      Stop();
   }
   */
  //delay(300);
}